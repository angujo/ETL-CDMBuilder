<QueryDefinition>
  <Query>
    select a.patid,
    a.eventdate,
    a.staffid,
    a.value_as_string,
    a.value_as_number,
    a.value_as_date,
    a.unit_source_value,
    right(cast(a.patid as varchar),5) as care_site_id,
    a.constype,
    (cast(a.patid as bigint) * 10000000000) +
    (cast(date_part('year',a.eventdate) as bigint) * 1000000) +
    (cast(date_part('month',a.eventdate) as bigint) * 10000) +
    (cast(date_part('day',a.eventdate) as bigint) * 100) + coalesce(a.constype, 99) as visit_occurrence_id,
    qualifier_source_value,
    case
    when a.qualifier_source_value = 'Not applicable' then 45882470
    when a.qualifier_source_value = 'Abnormal' then 45878745
    when a.qualifier_source_value = 'Absent' then 45884086
    when a.qualifier_source_value = 'High' then 45876384
    when a.qualifier_source_value = 'Low' then 45881666
    when a.qualifier_source_value = 'Negative' then 45878583
    when a.qualifier_source_value = 'Normal' then 45884153
    when a.qualifier_source_value = 'Positive' then 45884084
    when a.qualifier_source_value = 'Present' then 45879438
    when a.qualifier_source_value = 'Trace' then 45881796
    when a.qualifier_source_value = 'Unknown' then 45877986
    when a.qualifier_source_value = 'Very high' then 45879181
    when a.qualifier_source_value = 'Very low' then 45879182
    end as qualifier_concept_id,
    data,
    concat(concat(concat(concat(concat(concat(cast(enttype as varchar), '-'), category), '-'), description), '-') , data)  as source_value
    from
    (
    select a.patid,
    c.eventdate,
    con.constype,
    c.consid,
    c.staffid,
    a.enttype,
    e.category,
    e.description,
    e.data2 as data,
    case when e.data2_lkup in ('Medical Dictionary', 'Product Dictionary') then null
    else  a.data2
    end as value_as_number,
    case when e.data2_lkup = 'Medical Dictionary' then m.read_code
    when e.data2_lkup = 'Product Dictionary' then p.gemscriptcode
    else lu.text
    end as value_as_string,
    case when e.data2_lkup = 'dd/mm/yyyy' then a.data2
    end as value_as_date,
    case when a.enttype = 52 then 'hour' --enttype 52 is sleep pattern and this is asking average hours of sleep
    when a.enttype = 69 then 'week' --enttype 69 is weeks post-natal
    when a.enttype = 150 then 'day' --enttype 150 is days post-natal
    else ''
    end as unit_source_value,
    '' as qualifier_source_value,
    m.desc as read_code_description,
    p.productname as gemscript_description,
    e.data_fields
    from {sc}._chunks ch
    JOIN {sc}.additional a ON a.patid = ch.PERSON_ID and a.enttype not in (72,116,78,60,119,120)
    join {sc}.entity e on a.enttype = e.enttype AND e.data_fields &gt; 1
    left join {sc}.clinical c on c.patid = a.patid and c.adid = a.adid
    left join {sc}.lookuptype lt on e.data2_lkup = lt.name
    left join {sc}.lookup lu on lt.lookup_type_id = lu.lookup_type_id and lu.code::text =  a.data2
    left join {sc}.medical m on m.medcode::text =  a.data2 and e.data2_lkup = 'Medical Dictionary'
    left join {sc}.product p on p.prodcode::text =  a.data2  and e.data2_lkup = 'Product Dictionary'
    left join {sc}.consultation con on a.patid = con.patid and c.consid = con.consid
    where ch.ChunkId = {0}
    group by a.patid, c.eventdate, con.constype, c.consid, c.staffid, e.category, a.enttype, e.description, e.data_fields, e.data2,
    a.data2, lu.text, e.data2_lkup, m.read_code, m.desc, a.data2,
    p.productname, p.gemscriptcode
    ) as a
    where a.eventdate is not NULL order by a.patid
  </Query>
  <Observation>
    <ObservationDefinition>
      <PersonId>patid</PersonId>
      <StartDate>eventdate</StartDate>
      <ProviderId>staffid</ProviderId>
      <VisitDetailId>visit_occurrence_id</VisitDetailId>
      <QualifierConceptId>qualifier_concept_id</QualifierConceptId>
      <QualifierSourceValue>qualifier_source_value</QualifierSourceValue>
      <ValuesAsString>
        <string>value_as_string</string>
      </ValuesAsString>
      <ValuesAsNumber>
           <string>value_as_number</string>
         </ValuesAsNumber>
      <AdditionalFields>
        <string>data</string>
        <string>constype</string>
      </AdditionalFields>
      <Concepts>
        <Concept>
          <ConceptIdMappers>
            <Mapper>
              <Lookup>Additional</Lookup>
            </Mapper>
          </ConceptIdMappers>
          <Fields>
            <Field key="source_value" defaultTypeId="38000280" isNullable="true"/>
          </Fields>
        </Concept>
        <Concept>
          <ConceptIdMappers>
            <Mapper>
              <Lookup>Units</Lookup>
            </Mapper>
          </ConceptIdMappers>
          <Fields>
            <Field key="unit_source_value" defaultTypeId="0" />
          </Fields>
        </Concept>
      </Concepts>
    </ObservationDefinition>
  </Observation>
</QueryDefinition>